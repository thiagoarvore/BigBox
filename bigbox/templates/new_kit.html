{% extends 'base.html' %}

{% load widget_tweaks %}

{% block content %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="card shadow-sm">
                    <div class="card-body p-4">
                        <h1 class="h4 mb-3 text-center">Criar Kit</h1>

                        <form id="products-form" method="post">
                            {% csrf_token %}

                            <div class="row g-3 align-items-end">
                                <div class="col-12 col-md-6">
                                    <label class="form-label" for="{{ form.label.id_for_label }}">{{ form.label.label }}</label>
                                    {% render_field form.label class+="form-control" %}
                                    {% if form.label.errors %}
                                        <div class="invalid-feedback d-block">{{ form.label.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12 col-md-6">
                                    <label for="id_product_filter" class="form-label">Filtrar produtos</label>
                                    <input type="text" name="product_filter" id="id_product_filter" class="product-filter form-control" placeholder="Digite para filtrar...">
                                </div>
                            </div>

                            <hr>

                            <div class="row justify-content-center">
                                <div class="col-12 col-lg-10">
                                    <div class="border rounded p-3" style="max-height: 320px; overflow: auto;">
                                        {% if user.is_authenticated %}
                                            {% for field in form.visible_fields %}
                                                {% if field.name != 'label' %}
                                                    <div class="form-check">
                                                        {% render_field field class+="form-check-input" %}
                                                        <label class="form-check-label" for="{{ field.id_for_label }}">{{ field.label }}</label>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-primary">Criar</button>
                                <div id="total-value" class="btn btn-warning" role="button">Total: R$ 0,00</div>
                                <a href="{% url 'kit_list' %}" class="btn btn-outline-secondary">Voltar</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    
    <script>
        // Função para construir o array JS no carregamento da página
        document.addEventListener('DOMContentLoaded', function() {
            var productArray = {};
            // Itera sobre todos os produtos disponíveis no formulário
            document.querySelectorAll('[type="checkbox"]').forEach(function(checkbox) {
                var productId = checkbox.id; // Pega o valor do atributo "value" do checkbox
                var productPrice = checkbox.dataset.price; // Pega o valor do atributo "data-price" do checkbox
                // Adiciona ao array JS
                productArray[productId] = {
                    price: parseFloat(productPrice)
                };
            });
            console.log('productArray', productArray)
            // Calcula o somatório dos produtos selecionados
            function updateSelectedProductsTotal() {
                var total = 0;
                // Itera sobre os produtos selecionados
                document.querySelectorAll('[type="checkbox"]:checked').forEach(function(checkbox) {
                    var productId = checkbox.id;
                    total += productArray[productId].price;
                });
                // Atualiza o conteúdo da div
                document.getElementById('total-value').textContent = 'Total: R$ ' + total.toFixed(2);
                console.log('prod', total)
            }
            // Adiciona ouvinte de evento para chamar a função quando os checkboxes são alterados
            document.querySelectorAll('[type="checkbox"]').forEach(function(checkbox) {
                checkbox.addEventListener('change', function() {
                        updateSelectedProductsTotal();
                });
            });
            // Chama a função inicialmente para exibir o total no carregamento da página
            updateSelectedProductsTotal();
        });
        document.addEventListener('DOMContentLoaded', function() {
            var filterInput = document.querySelector('.product-filter');
            var checkboxes = document.querySelectorAll('[type="checkbox"]');

            filterInput.addEventListener('input', function() {
                var filterText = filterInput.value.toLowerCase();

                checkboxes.forEach(function(checkbox) {
                    var productName = checkbox.nextElementSibling.textContent.toLowerCase();
                    checkbox.parentElement.style.display = productName.includes(filterText) ? 'block' : 'none';
                });
            });
        });
    </script>
{% endblock %}